<!DOCTYPE html>
<html>
<head>
<style>
::-webkit-scrollbar {
  height: 8px;
  width: 8px;
}

/* Track */
::-webkit-scrollbar-track {
  background: lightgrey; 
}
 
/* Handle */
::-webkit-scrollbar-thumb {
  background: rgb(23,115,232); 
}

/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: rgb(23,115,232); 
}
p {
    font-family: "Helvetica";
}
#sheet-info-container {
    width: 30px;
    display: inline-block;
    vertical-align: top;
    height: 100%;
}
#sheet-container {
    width: 97%;
    overflow-y: overlay;
    overflow-y: hidden; 
    display: inline-block;
    height: 103%;
}
#sheet-info {
    width: 30px;
    height: 100%;
}
#sheet {
    height: 100%;
}
#container{
    vertical-align: top;
    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */
}

input {
    -webkit-touch-callout: none; /* iOS Safari */
    -webkit-user-select: none; /* Safari */
     -khtml-user-select: none; /* Konqueror HTML */
       -moz-user-select: none; /* Old versions of Firefox */
        -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
                                  supported by Chrome, Edge, Opera and Firefox */
}

</style>
</head>
<body>
<p><b>Music visualization</b></p>
<label for="voicing">Choose voicing:</label>
<select name="voicing" id="voicing">
  </select>
<button id="c-major-sort">c-major</button>
<button id="circle-of-fifths-sort">circle-of-fifths sort</button>
<button id="scale-degrees-only">Scale degrees only</button><br><br>

<label for="points">x-axis:</label>
<input id="measure-slider" type="range" name="points" min="0.3" max="1.5" step="0.1" value=1>

<label for="points">beat units:</label>
<input id="beat-unit-slider" type="range" name="points" value="2" min="0" max="8" step="2">

<label for="points">bar-height slider</label>
<input id="bar-height-slider" type="range" name="points" min="10" max="15" value="10">

<input checked type="checkbox" id="toggleTonalRelations" name="toggleTonalRelations" value="1">
<label for="toggleTonalRelations"> Show interval qualities</label>

<input type="checkbox" id="toggleAggregateNotes" name="toggleAggregateNotes" value="1">
<label for="toggleAggregateNotes"> Aggregate notes</label>

<input type="checkbox" id="toggleAggregateNotesOneOctave" name="toggleAggregateNotesOneOctave" value="1">
<label for="toggleAggregateNotesOneOctave"> Aggregate notes in one octave</label>

<input type="checkbox" id="toggleAggregateIntervals" name="toggleAggregateIntervals" value="1">
<label for="toggleAggregateIntervals"> Aggregate intervals</label>


<div id="container">
    <div id="sheet-info-container">
        <svg id="sheet-info"></svg>
    </div>
    <div id="sheet-container">
        <svg id="sheet"></svg>
    </div>
</div>
<br>
</body>
</html>

<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/x2js@3.4.1/x2js.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="sort-y.js"></script>
<script src="update-view.js"></script>
<script src="computations.js"></script>
<script src="draw.js"></script>

<script>
    const immutable_pitch_classes = ["C", "D♭", "D","E♭", "E","F", "G♭","G", "A♭", "A", "B♭","B"];
    const scale_of_measure = 100;
    const beat_units = scale_of_measure/16;
    const sheet_info = d3.select("#sheet-info");
    const sheet = d3.select("#sheet");
    const offset_top = 30;
    
    var pitch_classes = [];
    const interval_classes = [{halfstep:1, interval_name: "m2"}, {halfstep:2, interval_name: "M2"}, {halfstep:3, interval_name: "m3"}, {halfstep:4, interval_name: "M3"}, {halfstep:5, interval_name: "P4"}, {halfstep:6, interval_name: "tt"}, {halfstep:7, interval_name: "P5"}, {halfstep:8, interval_name: "m6"}, {halfstep:9, interval_name: "M6"}, {halfstep:10, interval_name: "m7"}, {halfstep:11, interval_name: "M7"}, {halfstep:12, interval_name: "P8"}];
    var circle_of_fifths = [];
    var c_major = [];
    var scale_degrees_only = []
    var sheet_height = 0;
    var bar_height = 10;
    var default_data;
    var highest_octave = 0;
    var lowest_octave = 10;
    var octave_span;
    var notes = [];
    var chords;

    slider_value = document.getElementById("measure-slider").value;

    d3.json("https://raw.githubusercontent.com/nordstroem92/musicviz/master/MusicJSON/New_Light.json").then(function(data) {
        default_data = data;
        data_part = default_data.part[2];
        setupUI(data);
        createNotesArray();
        getOctaveSpan();
        createPitchClassesArray();
        overwriteDefaultX();
        adjustSVGSize();
        drawNotes();
        drawStaffs();
        drawYLabels();
        drawMeasures();
        drawChordLabels();
        drawBeats(2);
        drawTonalRelations();
    });


    function setupUI(data){
        var select_voicing = document.getElementById("voicing");
        for (i = 0; i < data["part-list"].length; i++) {
            var node = document.createElement("option");   
            node.setAttribute("value", i)
            node.innerHTML = data["part-list"][i]['part-name'];
            select_voicing.append(node);
        }
    }

    function createNotesArray(){
        for(i = 0; i < data_part.measure.length; i++) {
            for (j = 0; j < data_part.measure[i].note.length; j++){
                notes.push(data_part.measure[i].note[j])
            }
        }
    }

    function createPitchClassesArray(){
        for(i = 1; i < octave_span+1; i++) {
            pitch_classes.push( 
            {name:"C", oct_index: i}, {name:"D♭", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"E♭", oct_index: i}, 
            {name:"E", oct_index: i}, {name:"F", oct_index: i}, 
            {name:"G♭", oct_index: i}, {name:"G", oct_index: i}, 
            {name:"A♭", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"B♭", oct_index: i}, {name:"B", oct_index: i}
            );

            circle_of_fifths.push(
            {name:"C", oct_index: i}, {name:"G", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"E", oct_index: i}, {name:"B", oct_index: i}, 
            {name:"G♭", oct_index: i}, {name:"D♭", oct_index: i}, 
            {name:"A♭", oct_index: i}, {name:"E♭", oct_index: i}, 
            {name:"B♭", oct_index: i}, {name:"F", oct_index: i}
            );

            c_major.push(
            {name:"C", oct_index: i}, {name:"D♭", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"E♭", oct_index: i}, 
            {name:"E", oct_index: i}, {name:"F", oct_index: i}, 
            {name:"G♭", oct_index: i}, {name:"G", oct_index: i}, 
            {name:"A♭", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"B♭", oct_index: i}, {name:"B", oct_index: i}
            );

            scale_degrees_only.push(
            {name:"G", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"B", oct_index: i}, {name:"C", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"E", oct_index: i}, 
            {name:"G♭", oct_index: i});
        }
    }
    
    function toggleTonalRelations() {
        var check = document.getElementById("toggleTonalRelations");
        if(!check.checked) {
            sheet.selectAll(".harmonic-relation").transition().duration(500).style("opacity", "0");
        } else {
            sheet.selectAll(".harmonic-relation").transition().duration(500).style("opacity", "1");
        }
    }

    function getIntervalY(d){
        if(d["chord"]) {
            return d["@default-y"]+bar_height;
        } else {
            return 100;
        }
    }

    function getIntervalHeight(d, i){
        if(d['chord'] && notes[i-1]["@default-y"]-d["@default-y"] > 0){
            return notes[i-1]["@default-y"]-d["@default-y"]-bar_height;
        } else {
            return 0;
        }
    }

    function getIntervalWidth(d){
        return d["@default-dx"]-d["@default-x"];
    }

    function getIntervalFill(d, i){
        if(d['chord']){
            var interval = immutable_pitch_classes.indexOf(d.pitch.step) - immutable_pitch_classes.indexOf(notes[i-1].pitch.step)
            if (interval < 0) { interval = 12+interval }
            if (interval == 0 || interval == 12 || interval == 7 || interval == 5) { //Perfect: p1 p8 p5 p4
                return "rgba(0,0,255,0.4)";
            } else if (interval == 3 || interval == 4 || interval == 8 || interval == 9) { //Imperfect: M3 m3 M6 m6
                return "rgba(255,0,255,0.4)";
            } else if (interval == 1 || interval == 2 || interval == 10 || interval == 11 || interval == 6) { //Dissonant: M2 m2 M7 m7 d5 A4
                return "rgba(255,0,0,0.5)"; 
            }
        } else {
            return 0;
        }
    }

    function getStaffOrLabelHeight(i){
        return sheet_height-(i+1)*bar_height;
    }

    function getOctaveSpan(){
        var note_octaves = [];
        for(i = 0; i < notes.length; i++){
            if(notes[i]['pitch']) {
                    highest_octave = (highest_octave > notes[i]['pitch']['octave']) ? highest_octave : notes[i]['pitch']['octave'];
                    lowest_octave = (lowest_octave < notes[i]['pitch']['octave']) ? lowest_octave : notes[i]['pitch']['octave'];
            }
        }
        octave_span = (parseInt(highest_octave)+1 - parseInt(lowest_octave))
    }

    function overwriteDefaultX(){
        var sum_previous_durations = 0;  
        for(i = 0; i < notes.length; i++){
            if (!notes[i]["grace"] && !notes[i]["chord"]) {
                    notes[i]['@default-x'] = sum_previous_durations;
                    sum_previous_durations += (beat_units)*parseInt(notes[i]["duration"]); 
                    notes[i]['@default-dx'] = sum_previous_durations;
                } else if(notes[i]["grace"]){ //not grace notes[i]s
                    notes[i]['@default-x'] = sum_previous_durations;
                    notes[i]['@default-dx'] = sum_previous_durations;
                } else if(notes[i]['chord']) {
                    notes[i]['@default-dx'] = sum_previous_durations; 
                    notes[i]['@default-x'] = sum_previous_durations - (beat_units)*parseInt(notes[i]["duration"]); 
                } 
        }
        for(i = 0; i < notes.length; i++){
            if(notes[i]["rest"]) {
                notes.splice(i, 1);
                i--;
            }
        }
    }

    function adjustSVGSize(){
        sheet_height = offset_top+octave_span*12*bar_height;
        d3.selectAll("#container")
        .style("height", sheet_height+"px")

        var sheet_width = data_part.measure.length*scale_of_measure;
        sheet.style("width", sheet_width+"px");
    }

    function get_note_y(d) {
        if (!d.pitch) {
            return 0;
        } else {
            var d_relative_oct = parseInt(d.pitch.octave) - lowest_octave+1; //this is probably a stupid solution
            var pitch_name = pitch_classes.find(pc => pc.name == d.pitch.step && pc.oct_index == d_relative_oct);
            var pitch_index = pitch_classes.indexOf(pitch_name)+1;
            d["@default-y"] = sheet_height-pitch_index*bar_height;
            return d["@default-y"];
        }
    }

    function get_note_color(d){
        var stroke_color = (d["pitch"]) ? "rgba(0, 0, 0, 0.6)" : "none";
        if(d['grace']){ stroke_color = "rgba(0, 0, 0, 0.6)";}
        return stroke_color;
    }

</script>
