<!DOCTYPE html>
<html>
<head>
<style>
::-webkit-scrollbar {
  height: 5px;
  width: 5px;
}

/* Track */
::-webkit-scrollbar-track {
  background: lightgrey; 
}
 
/* Handle */
::-webkit-scrollbar-thumb {
  background: rgb(23,115,232); 
}

/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: rgb(23,115,232); 
}
p {
    font-family: "Helvetica";
}
#sheet-info-container {
    width: 30px;
    display: inline-block;
    vertical-align: top;
    height: 100%;
}
#sheet-container {
    width: 97%;
    overflow-y: overlay;
    overflow-y: hidden; 
    display: inline-block;
    height: 100%;
}
#sheet-info {
    width: 30px;
    height: 100%;
}
#sheet {
    height: 100%;
}
#container{
    vertical-align: top;
}

</style>
</head>
<body>
<p>Music visualization</p>
<button id="ascending">ascending</button>
<button id="descending">descending</button>
<button id="c-major-sort">c-major</button>
<button id="circle-of-fifths-sort">circle-of-fifths sort</button><br>

<label for="points">x-axis:</label>
<input id="measure-slider" type="range" name="points" min="0.5" max="1.5" step="0.1">

<label for="points">beat units:</label>
<input id="beat-unit-slider" type="range" name="points" value="2" min="0" max="8" step="2">

<label for="points">bar-height slider</label>
<input id="bar-height-slider" type="range" name="points" min="10" max="20">

<div id="container">
    <div id="sheet-info-container">
        <svg id="sheet-info"></svg>
    </div>
    <div id="sheet-container">
        <svg id="sheet"></svg>
    </div>
</div>
<br>
</body>
</html>

<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/x2js@3.4.1/x2js.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="sort-y.js"></script>

<script>
    var musicjson;
    var pitch_classes = [{name:"C"}, {name:"D♭"}, {name:"D"}, {name:"E♭"}, {name:"E"}, {name:"F"}, {name:"G♭"}, {name:"G"}, {name:"A♭"}, {name:"A"}, {name:"B♭"}, {name:"B"}];
    const c_major = ["C", "D♭", "D", "E♭", "E", "F", "G♭", "G", "A♭", "A", "B♭", "B"];
    const circle_of_fifths = ["C", "G", "D", "A", "E", "B", "G♭", "D♭", "A♭", "E♭", "B♭, F"];
    const scale_of_measure = 100;
    const beat_units = scale_of_measure/16;
    const beat_offset = scale_of_measure/50;
    const sheet_info = d3.select("#sheet-info");
    const sheet = d3.select("#sheet");
    var sheet_height = 0;
    var bar_height = 15;
    const offset_top = 30;
    
    var data;
    var highest_octave = 0;
    var lowest_octave = 10;
    var octave_span;
    var notes = [];
    var chords;

    d3.json("https://raw.githubusercontent.com/nordstroem92/musicviz/master/MusicJSON/New_Light.json").then(function(data) {
        data = data;
        data_part = data.part[2];
        createNotesArray();
        getOctaveSpan();
        overwriteDefaultX();
        adjustSVGSize();
        drawNotes();
        drawYAxis();
        drawYLabels();
        drawMeasures();
        drawChordLabels();
        drawBeats(2);
        createChordsArray();
        drawTonalRelations();
        console.log(notes);
        console.log(chords);
    });

    function createNotesArray(){
        for(i = 0; i < data_part.measure.length; i++) {
            for (j = 0; j < data_part.measure[i].note.length; j++){
                notes.push(data_part.measure[i].note[j])
            }
        }
    }
    function createChordsArray(){
        chords = d3.group(notes, d => d['@default-x']);
        chords = Array.from(d3.group(chords.values()))
        for(i = 0; i < chords.length; i++) { //remove rest notes
            if(chords[i][0]['rest']) {
               chords.splice(i, 1);
               i--;
            }
        }
    }

    function drawTonalRelations(){
        for(i = 0; i < chords.length; i++){ 
                sheet.selectAll(".harmonic-relations")
                .data(chords[i])
                .enter()
                .append("rect")
                .attr("class", "harmonic-relation")
                .attr("y", (d, j) => {
                    if(chords[i][j+1] !== undefined){
                        return chords[i][j+1]["@default-y"]+bar_height/2;
                    } else {
                        return 1000;
                    }
                })
                .attr("x", d => d["@default-x"])
                .attr("width", d => d["@default-dx"]-d["@default-x"])
                .attr("height", (d, j) => {
                    if(chords[i][j+1] !== undefined){
                        return d["@default-y"]-chords[i][j+1]["@default-y"];
                    } else {
                        return 0;
                    }
                }).attr("fill",  (d, j) => {
                    var color = 0;
                    if(chords[i][j+1] !== undefined){
                        var interval = d["@default-y"]-chords[i][j+1]["@default-y"]
                        if(interval == 180 || interval == 150 || interval == 75 ||  interval == 105) {
                            color =  "rgba(0,0,255,0.3)";
                        } else if (interval == 15 || interval == 30 || interval == 150 || interval == 165 || interval == 90) {
                            color = "rgba(255,255,0,0.3)";
                        } else if (interval == 45 || interval == 60 || interval == 120 || interval == 135) {
                            color = "rgba(127,0,127,0.3)";
                        }
                        return color;
                    return color;
                    } else {
                        return 0;
                    } 
                });   
        }
    }

    function getOctaveSpan(){
        var note_octaves = [];
        for(i = 0; i < notes.length; i++){
            if(notes[i]['pitch']) {
                    highest_octave = (highest_octave > notes[i]['pitch']['octave']) ? highest_octave : notes[i]['pitch']['octave'];
                    lowest_octave = (lowest_octave < notes[i]['pitch']['octave']) ? lowest_octave : notes[i]['pitch']['octave'];
            }
        }
        octave_span = (parseInt(highest_octave)+1 - parseInt(lowest_octave))
    }

    function overwriteDefaultX(){
        var sum_previous_durations = 0;  
        for(i = 0; i < notes.length; i++){
            if (!notes[i]["grace"] && !notes[i]["chord"]) {
                    notes[i]['@default-x'] = sum_previous_durations;
                    sum_previous_durations += (beat_units)*parseInt(notes[i]["duration"]); 
                    notes[i]['@default-dx'] = sum_previous_durations;
                } else if(notes[i]["grace"]){ //not grace notes[i]s
                    notes[i]['@default-x'] = sum_previous_durations-beat_offset*2;
                    notes[i]['@default-dx'] = sum_previous_durations-beat_offset*2;
                } else if(notes[i]['chord']) {
                    notes[i]['@default-dx'] = sum_previous_durations; 
                    notes[i]['@default-x'] = sum_previous_durations - (beat_units)*parseInt(notes[i]["duration"]); 
                } 
        }
    }

    function adjustSVGSize(){
        sheet_height = offset_top+octave_span*12*bar_height;
        d3.selectAll("#container")
        .style("height", sheet_height+"px")

        var sheet_width = data_part.measure.length*scale_of_measure;
        sheet.style("width", sheet_width+"px");
    }

    function drawYAxis(){
        for (i = 0; i < octave_span; i++) {
            sheet.selectAll("rect.staffs")
            .data(pitch_classes)
            .enter()
            .append("rect")
            .attr("class", "staff")
            .attr("height", bar_height)
            .attr("width", "100%")
            .attr("y", (d, j) => sheet_height-((j+1)+(i*12))*bar_height)
            .style("fill", "none")
            .style("stroke", "rgba(0,0,0,0.5)")
            .style("stroke-width", "0.1");
        }
    }

    function drawYLabels(){
        for(i = 0; i < octave_span; i++) {
            sheet_info.selectAll(".info")
            .data(pitch_classes)
            .enter()
            .append("rect")
            .attr("class", "pitch-class")
            .attr("height", bar_height)
            .attr("width", "100%")
            .attr("y", (d, j) => { 
                return sheet_height-(((j+1)+i*12)*bar_height)})
            .attr("id", d => d.name)
            .style("fill", "none")
            .style("stroke", "rgba(0,0,0,0.5)")
            .style("stroke-width", "1")

            sheet_info.selectAll("text.y-labels")
            .data(pitch_classes)
            .enter()
            .append("text")
            .attr("class", "y-label")
            .attr("x", 8 )
            .attr("y", (d, j) => sheet_height-((j+i*12)*bar_height))
            .attr("font-size", "10px")
            .attr("font-family", "Arial")
            .text(d => d.name);
        } 
    }

    function drawMeasures() {
        sheet.selectAll("line.measure")
            .data(data_part.measure)
            .enter()
            .append("line")
            .attr("class", "measure")
            .attr("x1", d => parseInt(d["@number"])*scale_of_measure)
            .attr("y1", d => offset_top)
            .attr("x2", d => parseInt(d["@number"])*scale_of_measure)
            .attr("y2", d => sheet_height)
            .style("stroke", "black")
            .style("stroke-width", 1);
    }
    function drawBeats(s) {
        var segments = s; 
        var sum_of_measures = data_part.measure.length;

        sheet.selectAll("line.beat").attr("class", "beat").remove();
        for (i = 0; i < segments; i++) {
            sheet.selectAll("line.beats")
            .data(data_part.measure)
            .enter()
            .append("line")
            .attr("class", "beat")  
            .attr("x1", (d, j) => { 
                var length = (scale_of_measure)/segments;
                return (j+(i*sum_of_measures))*length;
            })
            .attr("y1", d => offset_top)
            .attr("x2", (d, j) => {
                var length = (scale_of_measure)/segments;
                return (j+(i*sum_of_measures))*length;
            })
            .attr("y2", d => sheet_height)
            .style("stroke", "rgba(100,100,100, 0.3)")
            .style("stroke-width", 1);
        }
    }

    function drawChordLabels(){;
        sheet.selectAll("text")
        .data(data_part.measure)
        .enter()
        .append("text")
        .attr("class", "harmony") 
        .attr("x", (d, i) => (i-1)*scale_of_measure)
        .attr("y", 20 )
        .attr("font-size", "14px")
        .attr("font-family", "Arial")
        .text(d => {
            if (d['harmony']) {
                if(d['harmony']['function']) {
                    return d['harmony']['function'];
                } else if (Array.isArray(d['harmony'])) {
                    var text = ""; 
                    for (i = 0; i < d['harmony'].length; i++) {
                        text += d['harmony'][i]['function']+" ";
                    }
                    return text;
                }
            } else {
                return "";
            }
        });

    }

    function drawNotes(){
        var sum_previous_durations = 0;
        sheet.selectAll(".rect")
        .data(notes)
        .enter()
        .append("rect")
        .attr("class", "note")
        .attr("height", bar_height/2)
        .attr("width",  d => (beat_units)*parseInt(d["duration"])-beat_offset) 
        .attr("x", d => d['@default-x'])
        .attr("y", d => get_note_y(d)+bar_height/4)
        .style("fill", d => get_note_color(d))
        .style("stroke",  d => get_note_color(d))
        .style("stroke-width", "1");
    
    }

    function get_note_y(d) {
        if (!d.pitch) {
            return 0;
        } else {
            var pitch_name = pitch_classes.find(pc => pc.name == d.pitch.step);
            var pitch_index = pitch_classes.indexOf(pitch_name)+1;
            var y = (pitch_index+(d.pitch.octave*12-lowest_octave*12))*bar_height;
            d["@default-y"] = sheet_height-y;
            return sheet_height-y;
        }
    }

    function get_note_color(d){
        var stroke_color = (d["pitch"]) ? "rgba(20, 20, 100, 0.5)" : "none";
        if(d['grace']){ stroke_color = "rgba(20, 20, 100, 0.5)";}
        return stroke_color;
    }
    
    function get_note_r(d) {
        if (!d["grace"]) {
            return bar_height/6;
        } else {
            return bar_height/10;
        }
    }

</script>
