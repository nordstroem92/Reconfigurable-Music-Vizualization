<!DOCTYPE html>
<html>
<head>
<style>
::-webkit-scrollbar {
  height: 5px;
  width: 5px;
}

/* Track */
::-webkit-scrollbar-track {
  background: lightgrey; 
}
 
/* Handle */
::-webkit-scrollbar-thumb {
  background: rgb(23,115,232); 
}

/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: rgb(23,115,232); 
}
p {
    font-family: "Helvetica";
}
#sheet-info-container {
    width: 30px;
    display: inline-block;
    vertical-align: top;
    height: 100%;
}
#sheet-container {
    width: 97%;
    overflow-y: overlay;
    overflow-y: hidden; 
    display: inline-block;
    height: 100%;
}
#sheet-info {
    width: 30px;
    height: 100%;
}
#sheet {
    height: 100%;
}
#container{
    vertical-align: top;
}

</style>
</head>
<body>
<p><b>Music visualization</b></p>
<label for="voicing">Choose voicing:</label>
<select name="voicing" id="voicing">
  </select>
<button id="c-major-sort">c-major</button>
<button id="circle-of-fifths-sort">circle-of-fifths sort</button><br><br>

<label for="points">x-axis:</label>
<input id="measure-slider" type="range" name="points" min="0.5" max="1.5" step="0.1">

<label for="points">beat units:</label>
<input id="beat-unit-slider" type="range" name="points" value="2" min="0" max="8" step="2">

<label for="points">bar-height slider</label>
<input id="bar-height-slider" type="range" name="points" min="10" max="20">

<input checked type="checkbox" id="toggleTonalRelations" name="toggleTonalRelations" value="1">
<label for="toggleTonalRelations"> Show interval qualities</label>

<input checked type="checkbox" id="toggleAggregateNotes" name="toggleAggregateNotes" value="1">
<label for="toggleAggregateNotes"> Aggregate notes</label>



<div id="container">
    <div id="sheet-info-container">
        <svg id="sheet-info"></svg>
    </div>
    <div id="sheet-container">
        <svg id="sheet"></svg>
    </div>
</div>
<br>
</body>
</html>

<script src="https://d3js.org/d3.v5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/x2js@3.4.1/x2js.min.js"></script>
<script src="https://d3js.org/d3-array.v2.min.js"></script>
<script src="sort-y.js"></script>
<script src="update-view.js"></script>
<script src="computations.js"></script>

<script>
    const immutable_pitch_classes = ["C", "D♭", "D","E♭", "E","F", "G♭","G", "A♭", "A", "B♭","B"];
    const scale_of_measure = 100;
    const beat_units = scale_of_measure/16;
    const beat_offset = scale_of_measure/50;
    const sheet_info = d3.select("#sheet-info");
    const sheet = d3.select("#sheet");
    const offset_top = 30;
    
    var pitch_classes = [];
    var circle_of_fifths = [];
    var c_major = [];
    var sheet_height = 0;
    var bar_height = 15;
    var default_data;
    var highest_octave = 0;
    var lowest_octave = 10;
    var octave_span;
    var notes = [];
    var chords;

    d3.json("https://raw.githubusercontent.com/nordstroem92/musicviz/master/MusicJSON/New_Light.json").then(function(data) {
        default_data = data;
        data_part = default_data.part[2];
        setupUI(data);
        createNotesArray();
        getOctaveSpan();
        createPitchClassesArray();
        overwriteDefaultX();
        adjustSVGSize();
        drawNotes();
        drawStaffs();
        drawYLabels();
        drawMeasures();
        drawChordLabels();
        drawBeats(2);
        drawTonalRelations();
    });


    function setupUI(data){
        var select_voicing = document.getElementById("voicing");
        for (i = 0; i < data["part-list"].length; i++) {
            var node = document.createElement("option");   
            node.setAttribute("value", i)
            node.innerHTML = data["part-list"][i]['part-name'];
            select_voicing.append(node);
        }
    }

    function createNotesArray(){
        for(i = 0; i < data_part.measure.length; i++) {
            for (j = 0; j < data_part.measure[i].note.length; j++){
                notes.push(data_part.measure[i].note[j])
            }
        }
    }

    function createPitchClassesArray(){
        for(i = 1; i < octave_span+1; i++) {
            pitch_classes.push( 
            {name:"C", oct_index: i}, {name:"D♭", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"E♭", oct_index: i}, 
            {name:"E", oct_index: i}, {name:"F", oct_index: i}, 
            {name:"G♭", oct_index: i}, {name:"G", oct_index: i}, 
            {name:"A♭", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"B♭", oct_index: i}, {name:"B", oct_index: i}
            );

            circle_of_fifths.push(
            {name:"C", oct_index: i}, {name:"G", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"E", oct_index: i}, {name:"B", oct_index: i}, 
            {name:"G♭", oct_index: i}, {name:"D♭", oct_index: i}, 
            {name:"A♭", oct_index: i}, {name:"E♭", oct_index: i}, 
            {name:"B♭", oct_index: i}, {name:"F", oct_index: i}
            );

            c_major.push(
            {name:"C", oct_index: i}, {name:"D♭", oct_index: i}, 
            {name:"D", oct_index: i}, {name:"E♭", oct_index: i}, 
            {name:"E", oct_index: i}, {name:"F", oct_index: i}, 
            {name:"G♭", oct_index: i}, {name:"G", oct_index: i}, 
            {name:"A♭", oct_index: i}, {name:"A", oct_index: i}, 
            {name:"B♭", oct_index: i}, {name:"B", oct_index: i}
            );
        }
    }
    
    function toggleTonalRelations() {
        var check = document.getElementById("toggleTonalRelations");
        if(!check.checked) {
            sheet.selectAll(".harmonic-relation").remove();
        } else {
            drawTonalRelations()
        }
    }

    function drawTonalRelations(){
        sheet.selectAll(".harmonic-relations")
            .data(notes)
            .enter()
            .append("rect")
            .attr("class", "harmonic-relation")
            .attr("x", d => d["@default-x"])
            .attr("y", (d, i) => {
                if(d["chord"]) {
                    return d["@default-y"]+bar_height/2;
                } else {
                    return 1000;
                }
            })
            .attr("height", (d, i) => {
                if(d['chord'] && notes[i-1]["@default-y"]-d["@default-y"] > 0){
                    return notes[i-1]["@default-y"]-d["@default-y"];
                } else {
                    return 0;
                }
            })
            .attr("width", d => d["@default-dx"]-d["@default-x"])
            .attr("fill", (d, i) => {
                if(d['chord']){
                    return getInterval(notes[i].pitch, notes[i-1].pitch);
                } else {
                    return 0;
                } 
        });
    }

    function getOctaveSpan(){
        var note_octaves = [];
        for(i = 0; i < notes.length; i++){
            if(notes[i]['pitch']) {
                    highest_octave = (highest_octave > notes[i]['pitch']['octave']) ? highest_octave : notes[i]['pitch']['octave'];
                    lowest_octave = (lowest_octave < notes[i]['pitch']['octave']) ? lowest_octave : notes[i]['pitch']['octave'];
            }
        }
        octave_span = (parseInt(highest_octave)+1 - parseInt(lowest_octave))
    }

    function overwriteDefaultX(){
        var sum_previous_durations = 0;  
        for(i = 0; i < notes.length; i++){
            if (!notes[i]["grace"] && !notes[i]["chord"]) {
                    notes[i]['@default-x'] = sum_previous_durations;
                    sum_previous_durations += (beat_units)*parseInt(notes[i]["duration"]); 
                    notes[i]['@default-dx'] = sum_previous_durations;
                } else if(notes[i]["grace"]){ //not grace notes[i]s
                    notes[i]['@default-x'] = sum_previous_durations-beat_offset*2;
                    notes[i]['@default-dx'] = sum_previous_durations-beat_offset*2;
                } else if(notes[i]['chord']) {
                    notes[i]['@default-dx'] = sum_previous_durations; 
                    notes[i]['@default-x'] = sum_previous_durations - (beat_units)*parseInt(notes[i]["duration"]); 
                } 
        }
        for(i = 0; i < notes.length; i++){
            if(notes[i]["rest"]) {
                notes.splice(i, 1);
                i--;
            }
        }
    }

    function adjustSVGSize(){
        sheet_height = offset_top+octave_span*12*bar_height;
        d3.selectAll("#container")
        .style("height", sheet_height+"px")

        var sheet_width = data_part.measure.length*scale_of_measure;
        sheet.style("width", sheet_width+"px");
    }

    function drawStaffs(){
        sheet.selectAll("rect.staffs")
        .data(pitch_classes)
        .enter()
        .append("rect")
        .attr("class", "staff")
        .attr("height", bar_height)
        .attr("width", "100%")
        .attr("y", (d, j) => sheet_height-(j+1)*bar_height)
        .style("fill", "none")
        .style("stroke", "rgba(0,0,0,0.5)")
        .style("stroke-width", "0.1");
    }

    function drawYLabels(){
        sheet_info.selectAll(".info")
        .data(pitch_classes)
        .enter()
        .append("rect")
        .attr("class", "pitch-class")
        .attr("height", bar_height)
        .attr("width", "100%")
        .attr("y", (d, j) => { 
           return sheet_height-(j+1)*bar_height
        })
        .attr("id", d => d.name)
        .style("fill", "none")
        .style("stroke", "rgba(0,0,0,0.5)")
        .style("stroke-width", "1")

        sheet_info.selectAll("text.y-labels")
        .data(pitch_classes)
        .enter()
        .append("text")
        .attr("class", "y-label")
        .attr("x", 8 )
        .attr("y", (d, j) => sheet_height-j*bar_height)
        .attr("font-size", "10px")
        .attr("font-family", "Arial")
        .text(d => {
            var d_octave = parseInt(lowest_octave)+parseInt(d.oct_index-1);
            return d.name + " " +d_octave;
        });
    }

    function drawMeasures() {
        sheet.selectAll("line.measure")
            .data(data_part.measure)
            .enter()
            .append("line")
            .attr("class", "measure")
            .attr("x1", d => parseInt(d["@number"])*scale_of_measure)
            .attr("y1", d => offset_top)
            .attr("x2", d => parseInt(d["@number"])*scale_of_measure)
            .attr("y2", d => sheet_height)
            .style("stroke", "black")
            .style("stroke-width", 1);
    }
    function drawBeats(s) {
        var segments = s; 
        var sum_of_measures = data_part.measure.length;

        sheet.selectAll("line.beat").attr("class", "beat").remove();
        for (i = 0; i < segments; i++) {
            sheet.selectAll("line.beats")
            .data(data_part.measure)
            .enter()
            .append("line")
            .attr("class", "beat")  
            .attr("x1", (d, j) => { 
                var length = (scale_of_measure)/segments;
                return (j+(i*sum_of_measures))*length;
            })
            .attr("y1", d => offset_top)
            .attr("x2", (d, j) => {
                var length = (scale_of_measure)/segments;
                return (j+(i*sum_of_measures))*length;
            })
            .attr("y2", d => sheet_height)
            .style("stroke", "rgba(100,100,100, 0.3)")
            .style("stroke-width", 1);
        }
    }

    function drawChordLabels(){;
        sheet.selectAll("text")
        .data(data_part.measure)
        .enter()
        .append("text")
        .attr("class", "harmony") 
        .attr("x", (d, i) => (i-1)*scale_of_measure)
        .attr("y", 20 )
        .attr("font-size", "14px")
        .attr("font-family", "Arial")
        .text(d => {
            if (d['harmony']) {
                if(d['harmony']['function']) {
                    return d['harmony']['function'];
                } else if (Array.isArray(d['harmony'])) {
                    var text = ""; 
                    for (i = 0; i < d['harmony'].length; i++) {
                        text += d['harmony'][i]['function']+" ";
                    }
                    return text;
                }
            } else {
                return "";
            }
        });

    }

    function drawNotes(){
        var sum_previous_durations = 0;
        sheet.selectAll(".rect")
        .data(notes)
        .enter()
        .append("rect")
        .attr("class", "note")
        .attr("height", bar_height/2)
        .attr("width",  (d, i) => {
            if(!d['grace']) {
                return (beat_units)*parseInt(d["duration"])-beat_offset;
            } else {
                return 0;
            }
        }) 
        .attr("x", d => d['@default-x'])
        .attr("y", d => get_note_y(d)+bar_height/4)
        .style("fill", d => get_note_color(d))
        .style("stroke",  d => get_note_color(d))
        .style("stroke-width", "1")
        .on("mouseover", function (d, i) {   //needs work
          d3.select(this).transition().duration('50')
               .style('fill', 'red')
        });
    }

    function get_note_y(d) {
        if (!d.pitch) {
            return 0;
        } else {
            var d_relative_oct = parseInt(d.pitch.octave) - lowest_octave+1; //this is probably a stupid solution
            var pitch_name = pitch_classes.find(pc => pc.name == d.pitch.step && pc.oct_index == d_relative_oct);
            var pitch_index = pitch_classes.indexOf(pitch_name)+1;
            d["@default-y"] = sheet_height-pitch_index*bar_height;
            return d["@default-y"];
        }
    }

    function get_note_color(d){
        var stroke_color = (d["pitch"]) ? "rgba(20, 20, 100, 0.5)" : "none";
        if(d['grace']){ stroke_color = "rgba(20, 20, 100, 0.5)";}
        return stroke_color;
    }

</script>
